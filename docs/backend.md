# Backend Architecture

## Overview

This document describes the backend architecture for the Zivan-Darkone monorepo.

---

## Current Phase

**Phase 4 ‚Äî Documentation (In Progress)**

| Phase | Status |
|-------|--------|
| Phase 1 ‚Äî Admin Demo Library | ‚úÖ Complete |
| Phase 2 ‚Äî Admin Cleanup | ‚úÖ Complete |
| Phase 3A ‚Äî Supabase Auth | ‚úÖ Complete |
| Phase 3B ‚Äî RBAC Hardening | ‚úÖ Complete |
| **Phase 4 ‚Äî Documentation** | üîÑ In Progress |
| Phase 5 ‚Äî Frontend Cleanup | ‚è∏Ô∏è Pending |

### Frontend Documents (Created)

| Document | Status |
|----------|--------|
| Frontend Cleanup Plan | ‚úÖ `/docs/frontend/frontend-cleanup-route-reduction-plan.md` |
| Frontend Variant Audit | ‚úÖ `/docs/frontend/frontend-variant-audit.md` |
| Phased Plan (Reference) | ‚úÖ `/docs/frontend/frontend-cleanup-phased-plan-reference.md` |

### Supabase Schema Documents

| Document | Status |
|----------|--------|
| Content Contract v2.0 | ‚úÖ `/docs/contracts/Admin_Frontend_Content_Contract.md` |
| Content Data Model | ‚úÖ `/docs/supabase/Content_Data_Model.md` (Docs Only ‚Äî Not Executed) |

See [`/docs/planned/README.md`](./planned/README.md) for remaining planned docs.

---

## Current State

- **Backend:** Supabase (connected)
- **Database:** PostgreSQL via Supabase
- **Authentication:** Supabase Auth (email/password)
- **Storage:** Not yet configured
- **RBAC:** user_profiles + user_roles tables

## Supabase Configuration

### Environment Variables
The following environment variables are required (set in root `.env`):

| Variable | Description |
|----------|-------------|
| `VITE_SUPABASE_URL` | Supabase project URL |
| `VITE_SUPABASE_ANON_KEY` | Supabase anon/public key |
| `VITE_SUPABASE_PROJECT_ID` | Supabase project ID (optional) |

### Env Loading (Monorepo)
Since the root `vite.config.ts` sets `root: "apps/admin"`, Vite would normally look for `.env` in `apps/admin/`. To load from repo root instead:
- Root `vite.config.ts` includes `envDir: path.resolve(__dirname)` to point Vite back to repo root.
- All env vars are defined in root `.env` file.
- Admin app reads `import.meta.env.VITE_SUPABASE_*` variables.

### Supabase Client
- **Root client:** `src/integrations/supabase/client.ts` (auto-generated by Lovable)
- **Admin client:** `apps/admin/src/lib/supabase.ts` (primary for admin app)
- The admin client includes defensive guards that throw clear errors if env vars are missing.

## Database Schema

### Tables

#### `user_profiles`
Stores additional user information beyond Supabase auth.

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID (PK) | References auth.users(id) |
| `email` | TEXT | User email |
| `full_name` | TEXT | Display name (nullable) |
| `avatar_url` | TEXT | Profile picture URL (nullable) |
| `created_at` | TIMESTAMPTZ | Creation timestamp |
| `updated_at` | TIMESTAMPTZ | Last update timestamp |

#### `user_roles`
Stores user role assignments for RBAC.

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID (PK) | Primary key |
| `user_id` | UUID | References auth.users(id) |
| `role` | app_role | Role enum value |
| `created_at` | TIMESTAMPTZ | Assignment timestamp |

#### `app_role` (Enum)
- `admin` - Full system access, can manage roles
- `editor` - Can edit content, CRM, marketing
- `viewer` - Read-only access to dashboard

### Database Functions

| Function | Description |
|----------|-------------|
| `has_role(user_id, role)` | Security definer function to check if user has a role |
| `get_user_roles(user_id)` | Returns all roles for a user |
| `handle_new_user()` | Trigger function to create profile on signup |
| `update_updated_at_column()` | Trigger function for updated_at timestamps |
| `assign_role(target_user_id, role)` | Admin-only RPC to assign a role to a user |
| `revoke_role(target_user_id, role)` | Admin-only RPC to revoke a role from a user |
| `list_users_with_roles()` | Admin-only RPC to list all users with their roles |

### Triggers

| Trigger | Table | Description |
|---------|-------|-------------|
| `on_auth_user_created` | auth.users | Creates user_profile on signup |
| `update_user_profiles_updated_at` | user_profiles | Updates updated_at on change |

### Row Level Security (RLS)

#### user_profiles
- Users can SELECT their own profile
- Users can UPDATE their own profile
- Users can INSERT their own profile
- **Admins can SELECT all profiles** (for user management)

#### user_roles
- Users can SELECT their own roles
- Only admins can INSERT roles
- Only admins can UPDATE roles
- Only admins can DELETE roles

## Route-Based Access Control (RBAC)

### Route Role Requirements

| Route Prefix | Required Roles | Description |
|--------------|----------------|-------------|
| `/system/*` | `admin` | Admin-only system management |
| `/content/*` | `admin`, `editor` | Content management |
| `/crm/*` | `admin`, `editor` | CRM management |
| `/marketing/*` | `admin`, `editor` | Marketing management |
| `/dashboards` | Any authenticated | Dashboard access |

### Access Control Flow

1. **Authentication Check**: User must be authenticated
2. **Role Check**: If route requires roles, user must have at least one
3. **Deny-by-Default**: Missing roles = redirect to 404 (not login)

### Sidebar Visibility

The sidebar dynamically filters menu items based on user roles:
- **Admin**: Sees all menu items
- **Editor**: Sees Dashboard, Content, CRM, Marketing (no System)
- **Viewer**: Sees Dashboard only
- **DEV-only**: Demo Library visible only in development mode

## Authentication Flow

### Sign In
1. User submits email/password
2. Supabase validates credentials
3. Session stored in localStorage
4. Auth state listener updates context
5. User redirected to dashboard

### Sign Up
1. User submits name, email, password
2. Supabase creates auth.users record
3. Trigger creates user_profiles record
4. Confirmation email sent (if enabled)
5. User redirected to sign-in

### Sign Out
1. User clicks logout
2. Supabase clears session
3. Auth state listener clears context
4. User redirected to sign-in

### Session Persistence
- Sessions persist across page refreshes via localStorage
- Auto token refresh enabled
- Auth state listener handles session changes

## Route Protection

### Protected Routes (require auth)
- `/dashboards` and all CMS module routes
- Unauthenticated ‚Üí redirect to `/auth/sign-in?redirectTo={path}`

### Public Routes (no auth required)
- `/auth/sign-in`
- `/auth/sign-up`
- `/auth/reset-password`
- `/auth/lock-screen`
- 404 catch-all

### Auth Page Redirect
- Authenticated users on `/auth/sign-in` or `/auth/sign-up` ‚Üí redirect to `/dashboards`

## Admin Role Seeding

To grant admin access to a user:

1. User signs up (creates profile automatically)
2. Run SQL in Supabase SQL Editor:

```sql
INSERT INTO public.user_roles (user_id, role)
VALUES ('<user-uuid-from-auth-users>', 'admin');
```

Note: Get the user UUID from Supabase Dashboard > Authentication > Users

---

## Phase History

### Phase 1: Demo Library (Complete)
- Created Demo Library registry and documentation
- Preserved Darkone UI patterns for reference
- Set up DEV-only showcase routes

### Phase 2A: Sidebar + Placeholder Routes (Complete)
- 12 CMS placeholder pages created
- Production/DEV menu separation

### Phase 2B: Dashboard Placeholder (Complete)
- CMS-ready dashboard layout
- KPI placeholders, welcome card

### Phase 3A: Supabase Auth + RBAC (Complete)
- Supabase Auth integration (email/password)
- user_profiles table with auto-creation trigger
- user_roles table with RLS policies
- Protected route guards
- Role badge display in profile dropdown

### Phase 3B: RBAC Hardening (Complete)
- Route-level RBAC guards with deny-by-default
- Sidebar role-based filtering
- Admin-only RPCs: `assign_role`, `revoke_role`, `list_users_with_roles`
- Admin policy for viewing all user profiles
- Roles management placeholder page with user list

---

## CMS Tables (Planned ‚Äî Documentation Complete)

Schema defined in [`/docs/supabase/Content_Data_Model.md`](./supabase/Content_Data_Model.md):

| Table | Purpose | Status |
|-------|---------|--------|
| `site_settings` | Global branding, SEO, social links | üìÑ Documented |
| `pages` | Static/CMS pages | üìÑ Documented |
| `hero_sections` | Homepage heroes | üìÑ Documented |
| `services` | Service offerings | üìÑ Documented |
| `projects` | Portfolio/projects | üìÑ Documented |
| `blog_posts` | Blog articles | üìÑ Documented |
| `testimonials` | Client testimonials | üìÑ Documented |
| `team_members` | Team profiles | üìÑ Documented |
| `awards` | Awards/recognition | üìÑ Documented |
| `faqs` | FAQ entries | üìÑ Documented |
| `contact_submissions` | Contact form data | üìÑ Documented |
| `newsletter_subscribers` | Newsletter signups | üìÑ Documented |

**Storage Buckets (Planned):**
- `media` (public) ‚Äî Images
- `documents` (private) ‚Äî PDFs, docs

> ‚ö†Ô∏è Schema NOT executed. Awaiting approval before migration.

---

*Last updated: 2025-12-15 - Phase 4 Content Data Model Documentation*
